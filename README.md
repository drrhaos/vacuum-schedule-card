# Vacuum Schedule Card

Кастомная карточка для Home Assistant, позволяющая создавать и управлять расписанием уборки для роботов-пылесосов (включая Dreame, Xiaomi M30S и другие) с использованием интеграции [dreame-vacuum](https://github.com/Tasshack/dreame-vacuum).

## Возможности

- ✅ Создание и управление расписаниями уборки
- ✅ Выбор дней недели для каждого расписания
- ✅ Установка времени уборки
- ✅ Выбор комнат для уборки (или уборка всех комнат)
- ✅ Включение/выключение расписаний одним кликом
- ✅ Редактирование и удаление расписаний
- ✅ Автоматическое создание и синхронизация автоматизаций в Home Assistant
- ✅ Мгновенное отображение изменений (диалог закрывается сразу, автоматизации создаются в фоне)
- ✅ Автоматическая перезагрузка автоматизаций после изменений
- ✅ Поддержка локализации (русский и английский языки)

## Установка

### Через HACS (рекомендуется)

1. Убедитесь, что у вас установлен [HACS](https://hacs.xyz/)
2. В HACS перейдите в раздел "Frontend"
3. Нажмите на три точки в правом верхнем углу → "Настройки" → "Пользовательские репозитории"
4. Добавьте репозиторий:
   - URL: `https://github.com/drrhaos/vacuum-schedule-card`
   - Категория: "Lovelace"
5. Найдите "Vacuum Schedule Card" в HACS и установите
6. Перезагрузите Home Assistant

**Установка из последних коммитов:**

HACS автоматически может устанавливать карточку из последних коммитов ветки `main`, так как файл `dist/vacuum-schedule-card.js` автоматически собирается и коммитится при каждом изменении исходного кода.

Для установки из последних коммитов:
- При установке в HACS выберите версию из выпадающего списка (если доступно)
- Или используйте кнопку "Redownload" для обновления до последней версии из ветки `main`
- HACS автоматически отслеживает изменения в репозитории и предлагает обновления

### Ручная установка

1. Скачайте файл `vacuum-schedule-card.js` из релизов (находится в папке `dist/`)
2. Скопируйте его в папку `www` в конфигурационном каталоге Home Assistant
3. Добавьте ресурс в Home Assistant:
   - Перейдите в "Настройки" → "Панели управления" → "Lovelace" → "Ресурсы"
   - Нажмите "Добавить ресурс"
   - URL: `/local/vacuum-schedule-card.js`
   - Тип: "JavaScript Module"
4. Перезагрузите Home Assistant

## Использование

### Добавление карточки на панель

1. Перейдите в режим редактирования панели Lovelace
2. Нажмите "Добавить карточку"
3. Выберите "Ручная конфигурация"
4. Добавьте следующую конфигурацию:

```yaml
type: custom:vacuum-schedule-card
entity: vacuum.your_vacuum_entity
```

Замените `vacuum.your_vacuum_entity` на идентификатор вашего пылесоса (например, `vacuum.xiaomi_m30s`).

### Создание расписания

1. Нажмите кнопку "Добавить" на карточке
2. Выберите дни недели (можно выбрать несколько)
3. Установите время уборки в формате ЧЧ:ММ
4. Выберите комнаты для уборки (можно выбрать несколько или оставить пустым для уборки всех комнат)
5. Включите или выключите расписание
6. Нажмите "Сохранить"

**Примечание:** После сохранения диалог закрывается сразу, а расписание появляется в списке. Автоматизации создаются автоматически в фоновом режиме.

### Управление расписаниями

- **Включение/выключение**: Используйте переключатель справа от расписания
- **Удаление**: Нажмите кнопку с иконкой корзины
- **Редактирование**: Нажмите на расписание для редактирования

## Настройка комнат

По умолчанию карточка использует список комнат из атрибутов вашего пылесоса. Если комнаты не определены, будут использованы стандартные названия:
- Гостиная
- Спальня
- Кухня
- Ванная

Для получения правильных ID комнат вашего пылесоса:

1. Откройте Developer Tools в Home Assistant
2. Перейдите на вкладку "Services"
3. Выберите сервис `dreame_vacuum.get_room_mapping`
4. Укажите `entity_id` вашего пылесоса
5. Вызовите сервис
6. Проверьте результат в логах или уведомлениях

## Автоматизации

Карточка автоматически создает и управляет автоматизациями в Home Assistant для каждого расписания. 

### Формат автоматизаций

Автоматизации создаются с идентификаторами вида:
- `vacuum_schedule_{schedule_id}_day_{day}`

Где:
- `schedule_id` - уникальный идентификатор расписания
- `day` - номер дня недели (0-6, где 0 = воскресенье, 1 = понедельник и т.д.)

### Структура автоматизации

Каждая автоматизация содержит:
- **Триггер**: Время уборки (например, `09:00:00`)
- **Условие**: День недели (например, `mon` для понедельника)
- **Действие**: Вызов сервиса `dreame_vacuum.vacuum_clean_segment` с указанием комнат

### Автоматическая синхронизация

- Автоматизации автоматически перезагружаются после создания, обновления или удаления расписания
- При изменении расписания старые автоматизации удаляются, новые создаются
- При отключении расписания все связанные автоматизации удаляются
- При включении расписания автоматизации создаются заново

## Локализация

Карточка автоматически определяет язык интерфейса Home Assistant и отображает текст на соответствующем языке. Поддерживаются следующие языки:

- **Русский** (ru) - автоматически определяется для языков, начинающихся с "ru"
- **Английский** (en) - используется по умолчанию для всех остальных языков

Язык определяется из настроек Home Assistant (`hass.locale.language` или `hass.language`). Если язык не определен или не поддерживается, используется английский.

## Требования

- Home Assistant 2023.1 или новее
- Интеграция [dreame-vacuum](https://github.com/Tasshack/dreame-vacuum) от Tasshack
- Робот-пылесос Dreame (Xiaomi M30S и другие модели)

## Разработка

### Сборка из исходников

1. Установите зависимости:
```bash
npm install
```

2. Соберите проект:
```bash
npm run build
```

3. Для разработки с автоматической пересборкой:
```bash
npm run watch
```

### Структура проекта

```
.
├── dist/
│   └── vacuum-schedule-card.js  # Скомпилированный файл
├── src/
│   ├── vacuum-schedule-card.ts  # Основной файл карточки
│   ├── types.ts                 # TypeScript типы
│   ├── translations.ts           # Переводы
│   └── utils/
│       ├── automations.ts        # Работа с автоматизациями
│       ├── api.ts                # API запросы
│       ├── rooms.ts              # Загрузка комнат
│       ├── formatters.ts         # Форматирование данных
│       └── i18n.ts              # Интернационализация
├── package.json                 # Зависимости проекта
├── tsconfig.json                # Конфигурация TypeScript
├── rollup.config.mjs            # Конфигурация сборки (Rollup)
├── hacs.json                    # Конфигурация HACS
├── LICENSE                      # Лицензия
├── CHANGELOG.md                 # История изменений
└── README.md                    # Документация
```

### Технологии

- **TypeScript** - типизированный JavaScript
- **Lit** - библиотека для создания веб-компонентов
- **Rollup** - сборщик модулей
- **Home Assistant WebSocket API** - для взаимодействия с Home Assistant
- **Home Assistant REST API** - для управления автоматизациями

## Устранение неполадок

### Карточка не отображается

1. Убедитесь, что ресурс добавлен в Lovelace (Настройки → Панели управления → Lovelace → Ресурсы)
2. Перезагрузите Home Assistant
3. Проверьте консоль браузера (F12) на наличие ошибок

### Расписания не сохраняются

1. Проверьте логи Home Assistant на наличие ошибок
2. Убедитесь, что интеграция dreame-vacuum установлена и работает
3. Проверьте, что entity_id пылесоса указан правильно в конфигурации карточки
4. Проверьте консоль браузера (F12) - ошибки отображаются с префиксом `[Vacuum Schedule Card]`

### Автоматизации не создаются

1. Проверьте права доступа - карточка должна иметь доступ к созданию автоматизаций
2. Проверьте логи Home Assistant и консоль браузера на наличие ошибок
3. Убедитесь, что интеграция dreame-vacuum работает корректно
4. Попробуйте создать автоматизацию вручную через Developer Tools

### Комнаты не отображаются

1. Убедитесь, что ваш пылесос поддерживает сегментированную уборку
2. Проверьте атрибуты пылесоса в Developer Tools → States
3. Используйте сервис `dreame_vacuum.get_room_mapping` для получения списка комнат

## Поддержка

Если у вас возникли проблемы или вопросы:

1. Проверьте раздел "Устранение неполадок" выше
2. Проверьте логи Home Assistant и консоль браузера на наличие ошибок
3. Создайте issue в репозитории проекта с описанием проблемы

## Лицензия

MIT

## Благодарности

- [Tasshack](https://github.com/Tasshack) за интеграцию dreame-vacuum
- Сообщество Home Assistant за поддержку
